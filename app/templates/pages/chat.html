{% extends 'base.html' %}

{% from 'macros/messageProfile.html' import messageTop   %}
{% from 'macros/messageProfile.html' import messageBottom   %}
{% from 'macros/messageProfile.html' import messages   %}

{% block content %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>

<div id="message-Interface"  class"" style="width:90%; margin:auto; margin-top: 70px; background:var(--White, #FFF);">
  
	{% set reciever %}
           {% set default_name="Alemaghens" %}
	 <div class="">
		 <p class="leading-[21px] font-normal font-roboto tracking-[1.5px] text-gray-800  text-[10px]" style="color: var(--Grey-Dark, #606060);"> {{ other_user.first_name }} </p>
		 <p class="leading-[21px] font-normal font-roboto tracking-[0.25px] text-gray-800  text-[14px]" style="color: var(--Grey-Darker, #2D2D2D);"> {{ other_user.last_name }} </p>
        </div>
       {% endset %}

       {% set image_profile %}
        <div class="">
		{% if other_user.is_tailor %}
		<a href= "{{ '/' ~ other_user.business_name }}">  <img src="{{ other_user.photo }}" class="w-8 h-8 rounded-full" alt="...">  </a>
               {% else %}
                   <div  class="w-12 h-12 flex items-center  p-2 justify-center  text-sm bg-pc-teal-light rounded-full   dark:focus:ring-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg"
                            width="40"
                            height="40"
                            viewBox="0 0 18 18"
                            fill="none">
                           <path d="M9.15037 9C11.2214 9 12.9004 7.32106 12.9004 5.25C12.9004 3.17893 11.2214 1.5 9.15037 1.5C7.07932 1.5 5.40039 3.17893 5.40039 5.25C5.40039 7.32106 7.07932 9 9.15037 9Z" stroke="#006060" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M2.25 16.5C2.67778 15.0249 3.56097 13.7228 4.7733 12.7799C5.98562 11.837 7.46501 11.3015 9 11.25C12.09 11.25 14.7225 13.4325 15.75 16.5" stroke="#006060" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                   </div>

               {% endif %}
       </div>
       {% endset %}

       {{ messageTop(reciever, image_profile, "top") }}
                    

      

       {% set full_imgs %}

                 <div class= "  mb-1 p-[2px] rounded-[6px]">
                                 <img src="{{ url_for('static', filename='images/product_image_3.png' ) }}" class="h-[255px] w-full" alt="...">


                 </div>


      {% endset %}

      <div id="messages"  class="flex flex-col  pt-16  ml-1 ">
	    
	     
	    {% for message in msg %}
            {% if message.product %}
               {% set imgs %}

                 <a href="{{ '/products/' ~ message.product.id}}">     
                    <div class= "flex flex-row gap-2  w-full  mb-2 p-[5px] rounded-[6px]" style="background-color:var(--White, #FFF);">
                         <div class="">
                                <img src="{{ message.product.img }}" class="h-[63px] rounded-md w-[63px]" alt="...">
                         </div>
                         <div class=" flex flex-col justify-between">
                             <p class="leading-[21px] font-normal font-roboto tracking-[0.4px] text-gray-800  text-[12px]" style="color: var(--Grey-Dark, #606060);" >{{message.product.name}}</p>
                            <p class="leading-[21px] font-normal font-roboto tracking-[0.4px] text-gray-800  text-[12px]" style="color:var(--Grey-Dark, #606060);" >{{message.product.price |currency }}</p>
                            <p class="leading-[21px] font-normal font-roboto tracking-[0.25px] text-gray-800  text-[14px]" style="color:var(--Grey-Darker, #2D2D2D);" >Order ID: #232102</p>

                         </div> 


                     </div>
                </a>

               {% endset %}
                {% if  current_user.is_tailor %}
                  {% if message.sender_tailor_id %}
		             {{ messages('right', message.message, message.created_at | custom_timeago, imgs) }}
                 
		          {% else %}
		             {{ messages('left', message.message, message.created_at | custom_timeago, imgs) }}  
		          {% endif %}
         
               {% else %}
	              {% if message.sender_user_id %}
		              {{ messages('right', message.message, message.created_at | custom_timeago, imgs) }}
                 
                  {% else %}
                       {{ messages('left', message.message, message.created_at | custom_timeago, imgs) }} 
                  {% endif %}

                  
	           {% endif %}
                     


               
            {% else %}
	           {% if  current_user.is_tailor %}
                  {% if message.sender_tailor_id %}
		             {{ messages('right', message.message, message.created_at | custom_timeago) }}
                 
		          {% else %}
		             {{ messages('left', message.message, message.created_at | custom_timeago) }}  
		          {% endif %}
         
               {% else %}
	              {% if message.sender_user_id %}
		              {{ messages('right', message.message, message.created_at | custom_timeago) }}
                 
                  {% else %}
                       {{ messages('left', message.message, message.created_at | custom_timeago) }} 
                  {% endif %}

                  
	           {% endif %}
                     


            {% endif %}
	    {% endfor %}
          


      </div>
      <div class="mt-[100px]">
      </div>
      {% set  plus %}

           <svg id="attach-button" xmlns="http://www.w3.org/2000/svg" width="14" height="15" viewBox="0 0 14 15" fill="none" style=" cursor: pointer;">
                 <path d="M1 7.5H7M7 7.5H13M7 7.5V13.5M7 7.5V1.5" stroke="#2D2D2D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <input type="file" id="file-input" style="display: none;" accept="image/*" multiple="false">

      {% endset %}
 
      {% set input_message %}

          <div >
		  <input id="message-input" type="text" id="msg" class="rounded-lg placeholder-black   focus:outline-none focus:ring-0 focus:border-[white]  peer w-full" placeholder="Type here...." autocomplete="off">
         </div>

      {% endset %}
     
      {% set send_btn %}
      <div id="send" class="">   <svg xmlns="http://www.w3.org/2000/svg" width="24" height="25" viewBox="0 0 24 25" fill="none">
                          <path d="M11.5003 12.5H5.41872M5.24634 13.2972L4.24158 16.2986C3.69128 17.9424 3.41613 18.7643 3.61359 19.2704C3.78506 19.71 4.15335 20.0432 4.6078 20.1701C5.13111 20.3161 5.92151 19.9604 7.50231 19.2491L17.6367 14.6886C19.1797 13.9942 19.9512 13.6471 20.1896 13.1648C20.3968 12.7458 20.3968 12.2541 20.1896 11.8351C19.9512 11.3529 19.1797 11.0057 17.6367 10.3114L7.48483 5.74303C5.90879 5.03382 5.12078 4.67921 4.59799 4.82468C4.14397 4.95101 3.77572 5.28336 3.60365 5.72209C3.40551 6.22728 3.67772 7.04741 4.22215 8.68767L5.24829 11.7793C5.34179 12.061 5.38855 12.2019 5.407 12.3459C5.42338 12.4738 5.42321 12.6032 5.40651 12.731C5.38768 12.875 5.34057 13.0157 5.24634 13.2972Z" stroke="#2D2D2D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
	  </div>
      {% endset %}
       {{ messageBottom(input_message, send_btn,"buttom",  plus) }}
       <div  id="preview" style="position: fixed; bottom: 50px; right: 0px; left: 0px; z-index: 199; margin-bottom: 20px;">

        <img style=" display: none;" src="" class="h-[180px] rounded-md w-[100px]" alt="Image preview">
       </div>
     
</div>


    <script>
function getCurrentTime24() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;

	    }
function sleep(ms) {
  return new Promise(resolve => setTimeout(resolve, ms));
}

async function demo() {
  await sleep(0);
   window.scrollBy(0, document.body.offsetHeight)
		    // Sleep for 2000 milliseconds (2 seconds)
}

document.addEventListener('DOMContentLoaded', (event) => {
demo();

	    });
	    // Establish a connection to the server using Socket.IO
const socket = io.connect();

// Event listener for successful connection
socket.on('connect', () => {
    console.log('Connected to the server');
});

// Event listener for disconnection
socket.on('disconnect', () => {
    console.log('Disconnected from the server');
});

// Event listener for receiving a message from the server
socket.on('recieve_message', (data) => {
    console.log("Message received event fired");
    // Select the messages container in the DOM
    const messagesContainer = document.getElementById('messages');

    // Create the HTML for the received message
    const messageHTML = `{{ messages('left', '${data.message}', '${getCurrentTime24()}') }}`;
    messagesContainer.scrollBottom = messagesContainer.scrollHeight;
    // Append the new message to the messages container
    messagesContainer.innerHTML += messageHTML;
});



// Event listener for error handling
socket.on('error', (data) => {
    alert(data.error);
});
document.getElementById('attach-button').addEventListener('click', function() {
  document.getElementById('file-input').click();
});
document.getElementById('file-input').addEventListener('change', function(event) {
  const file = event.target.files[0];
  const maxSize = 50 * 1024 * 1024; // 50 MB in bytes
  const msgg = document.getElementById('btm-msg');
  if (file) {
    if (file.size > maxSize) {
      alert('File size exceeds 50 MB. Please select a smaller file.');
      // Clear the file input
      document.getElementById('file-input').value = '';
      document.querySelector('#preview img').style.display = 'none';
      return;
    }

    // Handle the selected file (e.g., upload it, display a preview, etc.)
    console.log('Selected file:', file);
    
    console.log(msgg);
    const reader = new FileReader();
    reader.onload = function(e) {
      const previewImg = document.querySelector('#preview img');
      console.log(previewImg, "dklfajsdlkfjsdkfjsdkjf")
      previewImg.src = e.target.result;
      previewImg.style.display = 'block'; // Show the preview image
    };
    reader.readAsDataURL(file);
  }
});

// Function to handle sending a message when the send button is clicked
document.getElementById('send').onclick = function() {
    console.log("Send button clicked event fired");

    // Get the value from the message input field
    const messageInput = document.getElementById('message-input');
    const messageText = messageInput.value;

    // Check if the message text is empty
    if (!messageText) {
        alert('Message and image cannot both be empty');
    } else {
        // Emit the message to the server using Socket.IO
        socket.emit('send_message', {
            reciever_id: `{{ other_user.id }}`,  // Replace with actual receiver ID from your template
            message: messageText
        });

        // Append the sent message to the messages container
        const messagesContainer = document.getElementById('messages');
        const messageHTML = `{{ messages('right', '${messageText}', '${getCurrentTime24()}') }}`;
        messagesContainer.innerHTML += messageHTML;
        demo();


        // Clear the message input field
        messageInput.value = '';
    }
};

    </script>
{% endblock %}

