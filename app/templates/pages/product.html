{% extends 'base.html' %}

{% from 'macros/tailorProductCard.html' import tailorProductCard %}
{% from 'macros/productReview.html' import productReview %}
{% from 'macros/tailorBadge.html' import tailorBadge %}
{% from 'macros/productCard.html' import productCard %}
{% from 'macros/bottomSheet.html' import bottomSheet %}
{% from 'macros/messageProfile.html' import modalMessageTop   %}
{% from 'macros/messageProfile.html' import messageBottom   %}
{% from 'macros/messageProfile.html' import messages   %}


{% from 'macros/productsContainer.html' import productsContainer   %}
{% block content %}
    <div x-data="{addedToCart: false}"
         class="md:space-y-0 md:space-x-8 rtl:space-x-reverse md:flex md:items-center">

        <div id="default-carousel" class="relative w-full" data-carousel="slide">
            <!-- Carousel wrapper -->
            <div class="relative aspect-[0.977] overflow-hidden md:h-96">
                <!-- Item 1 -->
                {% for img_url in product.img_urls %}
                    <div class="hidden w-full duration-700 ease-in-out]" data-carousel-item>
                        <img src="{{ img_url }}"
                             class="absolute object-cover bg-center block w-full h-full -translate-x-1/2 -translate-y-1/2 top-1/2 left-1/2"
                             alt="..." />
                    </div>
                {% endfor %}
            </div>

            <!-- Like button -->
            <div class="absolute top-0 end-0 z-30 p-2 space-x-3 rtl:space-x-reverse">
                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-black/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-1 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="16"
                         height="16"
                         viewBox="0 0 18 18"
                         fill="none">
                        <path d="M15.1151 8.21402L15.1151 8.21405C14.784 9.92327 13.26 11.5924 11.7086 12.8782C10.9472 13.5092 10.2066 14.0259 9.65586 14.385C9.38264 14.5631 9.15704 14.7018 8.99998 14.7959C8.84292 14.7018 8.61732 14.5631 8.3441 14.385C7.79334 14.0259 7.05275 13.5092 6.29139 12.8782C4.73998 11.5924 3.21601 9.92327 2.88485 8.21405L2.88485 8.21402C2.5438 6.45434 2.88558 5.18506 3.50015 4.36701C4.11727 3.54555 5.04786 3.12491 5.99998 3.12491H6.01589L6.03176 3.12389C6.53156 3.09206 7.03087 3.19328 7.47881 3.41725C7.92675 3.64122 8.30731 3.97993 8.58172 4.39887L8.99998 5.03743L9.41824 4.39887C9.69265 3.97993 10.0732 3.64122 10.5212 3.41725C10.9691 3.19328 11.4684 3.09206 11.9682 3.12389L11.9841 3.12491H12C12.9521 3.12491 13.8827 3.54555 14.4998 4.36701C15.1144 5.18506 15.4562 6.45434 15.1151 8.21402Z" stroke="white" />
                    </svg>
                    <span class="sr-only">Like</span>
                </span>

                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-black/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-1 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg"
                         width="16"
                         height="16"
                         viewBox="0 0 16 16"
                         fill="none">
                        <path d="M5.75 9.125L10.25 11.375M10.25 4.625L5.75 6.875M12.5 14.75C11.2573 14.75 10.25 13.7427 10.25 12.5C10.25 11.2573 11.2573 10.25 12.5 10.25C13.7427 10.25 14.75 11.2573 14.75 12.5C14.75 13.7427 13.7427 14.75 12.5 14.75ZM3.5 10.25C2.25736 10.25 1.25 9.24268 1.25 8C1.25 6.75732 2.25736 5.75 3.5 5.75C4.74264 5.75 5.75 6.75732 5.75 8C5.75 9.24268 4.74264 10.25 3.5 10.25ZM12.5 5.75C11.2573 5.75 10.25 4.74264 10.25 3.5C10.25 2.25736 11.2573 1.25 12.5 1.25C13.7427 1.25 14.75 2.25736 14.75 3.5C14.75 4.74264 13.7427 5.75 12.5 5.75Z" stroke="white" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    <span class="sr-only">Share</span>
                </span>

            </div>
            <!-- Slider indicators -->


            <div x-data="{ imgUrls: {{ product.img_urls }} }"
                 class="absolute z-30 flex -translate-x-1/2 bottom-5 left-1/2 space-x-3 rtl:space-x-reverse">
                <button type="button"
                        class="w-2 h-2 rounded-full"
                        aria-current="true"
                        aria-label="Slide 1"
                        x-show="imgUrls[0]"
                        data-carousel-slide-to="0">
                </button>
                <button type="button"
                        class="w-2 h-2 rounded-full"
                        aria-current="false"
                        aria-label="Slide 2"
                        x-show="imgUrls[1]"
                        data-carousel-slide-to="1">
                </button>
                <button type="button"
                        class="w-2 h-2 rounded-full"
                        aria-current="false"
                        x-show="imgUrls[2]"
                        aria-label="Slide 3"
                        data-carousel-slide-to="2">
                </button>
                <button type="button"
                        class="w-2 h-2 rounded-full"
                        aria-current="false"
                        aria-label="Slide 4"
                        x-show="imgUrls[3]"
                        data-carousel-slide-to="3">
                </button>
            </div>


            {% if product.img_urls | length > 1 %}
                <button type="button"
                        class="absolute top-0 start-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
                        data-carousel-prev>
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-black/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-1 group-focus:ring-white/5 dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                        <svg class="w-4 h-4 text-white dark:text-gray-800 rtl:rotate-180"
                             aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 6 10">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M5 1 1 5l4 4" />
                        </svg>
                        <span class="sr-only">Previous</span>
                    </span>
                </button>
                <button type="button"
                        class="absolute top-0 end-0 z-30 flex items-center justify-center h-full px-4 cursor-pointer group focus:outline-none"
                        data-carousel-next>
                    <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-black/30 dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-1 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                        <svg class="w-4 h-4 text-white dark:text-gray-800 rtl:rotate-180"
                             aria-hidden="true"
                             xmlns="http://www.w3.org/2000/svg"
                             fill="none"
                             viewBox="0 0 6 10">
                            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m1 9 4-4-4-4" />
                        </svg>
                        <span class="sr-only">Next</span>
                    </span>
                </button>

            {% endif %}
            <!-- Slider controls -->



        </div>

        <!-- Product Information -->
        <div x-data="{ isTailor: {{ 'true' if current_user.is_tailor else 'false' }} }"
             class="px-4 w-full font-roboto font-normal space-y-8">
            <div role="info" class="flex py-4 flex-col gap-y-3 text-black">
                <h2 class="text-xl leading-8">
                    {{ product.name }}
                </h2>
                <div class="flex justify-between">
                    <h3 class="inline-flex items-center space-x-3 rounded-md px-2 bg-sc-gray-light">
                        <span class="text-xs leading-5">starts at</span>
                        <p class="font-dosis font-semibold tracking-wide leading-9 text-[18px] leading-8">
                            {{ product.price | currency }}
                        </p>
                    </h3>

                    <p class="inline-flex items-center space-x-2">
                        <span class="max-w-20 text-xs text-sc-gray-darker leading-5"> {{ product.material }}</span>
                        <span>
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 width="18"
                                 height="19"
                                 viewBox="0 0 18 19"
                                 fill="none">
                                <path d="M5.28735 5.78735H5.29485M7.88385 2.75H5.85C4.58988 2.75 3.95982 2.75 3.47852 2.99524C3.05515 3.21095 2.71095 3.55515 2.49524 3.97852C2.25 4.45982 2.25 5.08988 2.25 6.35V8.38385C2.25 8.93412 2.25 9.2093 2.31217 9.46827C2.36729 9.69785 2.45819 9.9173 2.58156 10.1187C2.7207 10.3457 2.91527 10.5402 3.30442 10.9294L6.82942 14.4544C7.72042 15.3454 8.166 15.791 8.67967 15.9579C9.13162 16.1047 9.61837 16.1047 10.0703 15.9579C10.584 15.791 11.0296 15.3454 11.9206 14.4544L13.9544 12.4206C14.8454 11.5296 15.291 11.084 15.4579 10.5703C15.6047 10.1184 15.6047 9.63162 15.4579 9.17967C15.291 8.666 14.8454 8.22042 13.9544 7.32942L10.4294 3.80442C10.0402 3.41527 9.8457 3.2207 9.61867 3.08156C9.4173 2.95819 9.19785 2.86729 8.96827 2.81217C8.7093 2.75 8.43412 2.75 7.88385 2.75ZM5.66235 5.78735C5.66235 5.99446 5.49446 6.16235 5.28735 6.16235C5.08024 6.16235 4.91235 5.99446 4.91235 5.78735C4.91235 5.58024 5.08024 5.41235 5.28735 5.41235C5.49446 5.41235 5.66235 5.58024 5.66235 5.78735Z" stroke="#2D2D2D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            </svg>
                        </span>
                    </p>
                </div>

                {% if current_user.is_authenticated %}
                    <button :class="{ 'bg-sc-gray-light': isTailor, 'bg-blue-500': !isTailor, 'bg-pc-teal-normal/50' : {{'false' if product.tailor.is_available else 'true'}} }"
                            x-bind:disabled="{{ 'false' if product.tailor.is_available else 'true' }}"
                            data-drawer-target="bottom-sheet-measurement"
                            data-drawer-show="bottom-sheet-measurement"
                            data-drawer-placement="bottom"
                            aria-controls="add-measurement"
                            type="button"
                            class="text-white mb-0 text-sm  w-full hover:bg-gradient-to-br focus:ring-1 focus:outline-none focus:ring-teal-300 dark:focus:ring-teal-800 font-medium rounded-lg px-5 py-2.5 text-center me-2 mb-2">
                        Order
                    </button>

                    {% if not product.tailor.is_available %}
                    <p class="text-[10px] leading-4 -mt-1 tracking-wider inline-flex w-full justify-center items-center text-sc-gray-dark">
                        <svg class="text-sc-gray-dark me-1" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16" fill="none">
                            <path d="M8.00008 13.7599C11.2696 13.7599 13.9201 11.1094 13.9201 7.83992C13.9201 4.5704 11.2696 1.91992 8.00008 1.91992C4.73055 1.91992 2.08008 4.5704 2.08008 7.83992C2.08008 11.1094 4.73055 13.7599 8.00008 13.7599Z" stroke="#606060" stroke-linecap="round" stroke-linejoin="round"/>
                            <path d="M7.97519 5.27797L7.97534 5.27808C7.98602 5.28567 7.99844 5.29035 8.01143 5.29171C8.03278 5.29056 8.05308 5.28176 8.06855 5.2668L8.41619 5.62617M7.97519 5.27797L7.9665 5.16154C7.97729 5.15111 7.99083 5.14415 8.00543 5.14143L8.00545 5.14142C8.02014 5.13869 8.03533 5.14035 8.049 5.14614L8.04903 5.14615C8.06274 5.15196 8.07443 5.16167 8.08265 5.17408L8.08279 5.17429C8.08998 5.18512 8.09425 5.19766 8.09519 5.21068C8.09333 5.23201 8.08385 5.25199 8.06845 5.2669L8.41619 5.62617M7.97519 5.27797C7.9632 5.26945 7.95389 5.25752 7.94851 5.24354L7.94841 5.2433M7.97519 5.27797L7.94841 5.2433M8.41619 5.62617C8.52761 5.51833 8.592 5.37086 8.59539 5.21582L8.00012 5.7918C8.1552 5.79352 8.3047 5.73402 8.41619 5.62617ZM7.94841 5.2433C7.94308 5.22946 7.94194 5.21438 7.94513 5.1999L7.94519 5.19964M7.94841 5.2433L7.94519 5.19964M7.94519 5.19964C7.94837 5.18522 7.95573 5.17197 7.96649 5.16156L7.94519 5.19964ZM7.99354 10.5792L7.99379 10.5793M7.99354 10.5792L7.9932 10.5796L7.99354 10.5792ZM7.99354 10.5792L7.99379 10.5793M7.99379 10.5793L7.99379 10.5793M7.99379 10.5793L7.99379 10.5793M7.99375 7.12305L7.99384 7.12309L7.99375 7.12305ZM7.99375 7.12305L7.99356 7.12298L7.99375 7.12305ZM7.99379 10.5793L7.82233 10.9929L7.99379 10.5793Z" stroke="#606060"/>
                          </svg>
                          
                          <span class="font-roboto">
                            This tailor is offline and is currently not accepting orders!
                          </span>
                    </p>
                    {% endif %}

                {% else %}
                    <a href="{{ url_for('auth_views.login', next='products/' ~ product.id ) }}"
                       class="text-white  text-sm  w-full bg-gradient-to-r from-pc-teal-normal to-pc-teal-normal  hover:bg-gradient-to-br focus:ring-1 focus:outline-none focus:ring-teal-300 dark:focus:ring-teal-800 font-medium rounded-lg px-5 py-2.5 text-center me-2 mb-2">Order</a>
                {% endif %}
                <div>
                    <h3 class="text-base leading-6 tracking-[0.5px]">
                        Description
                    </h3>
                    <p class="text-sm leading-6 text-sc-gray-darker">

                        {{ product.description }}
                    </p>
                </div>
            </div>
        </div>


        {% if not current_user.is_tailor %}
            <div class="p-4">
                {{ tailorProductCard(product.tailor) }}
            </div>
        {% endif %}

        <!-- Reviews -->
        <section class="p-4" id="accordion-collapse" data-accordion="collapse">
            <h3 id="accordion-collapse-heading-1">
                <button type="button"
                        class="border-0 flex items-center justify-between w-full py-2 font-medium rtl:text-right border-b-1 border-b-[#939393]  bg-inherit dark:focus:ring-gray-800 dark:border-gray-700 dark:text-gray-400  dark:hover:bg-gray-800 gap-3"
                        data-accordion-target="#accordion-collapse-body-1"
                        aria-expanded="true"
                        aria-controls="accordion-collapse-body-1">
                    <div class="flex flex-col justify-center items-start gap-y-3">
                        <h3 class="text-base font-normal leading-6 tracking-wide">
                            Reviews
                        </h3>
                        <p class="flex items-center gap-2 text-black leading-5 text-xs">
                            <span class="bg-[#EFBF13] p-1 tracking-wide rounded-sm text-xs">{{ product.reviews | average_reviews}}/5</span> <span class="tracking-wide"> {{product.reviews | length }} reviews</span>
                        </p>
                    </div>
                    <svg data-accordion-icon
                         class="w-5 h-5 rotate-180 shrink-0 text-sc-gray-dark"
                         aria-hidden="true"
                         xmlns="http://www.w3.org/2000/svg"
                         fill="none"
                         viewBox="0 0 10 6">
                        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M9 5 5 1 1 5" />
                    </svg>
                </button>
            </h3>


            {% if product.reviews | length > 0 %}
                <div id="accordion-collapse-body-1"
                    class="hidden"
                    aria-labelledby="accordion-collapse-heading-1">
                    <div id="animation-carousel"
                            class="relative w-full"
                            data-carousel="static">
                        <!-- Carousel wrapper -->
                        <div class="relative min-h-[260px] overflow-hidden rounded-lg md:h-96">
                            {% for review in product.reviews %}
                                <div class="duration-200 ease-linear" data-carousel-item>
                                    {{ productReview(review) }}
                                </div>
                            
                            {% endfor %}

                            <!-- controls -->
                            {% if product.reviews | length > 1 %}
                                    <button type="button"
                                class="absolute bottom-0 start-1/4 z-30 flex items-end justify-center h-full px-4 cursor-pointer group focus:outline-none"
                                data-carousel-prev>
                                <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-sc-gray-light-active dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-4 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                                    <svg xmlns="http://www.w3.org/2000/svg"
                                        width="24"
                                        height="24"
                                        viewBox="0 0 24 24"
                                        fill="none">
                                        <path d="M15.4998 19L9.20696 12.7071C8.81643 12.3166 8.81643 11.6834 9.20696 11.2929L15.4998 5" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    </svg>
                                    <span class="sr-only">Previous</span> 
                                </span>
                                    </button>
                                    <button type="button"
                                            class="absolute bottom-0 end-1/4 z-30 flex items-end justify-center h-full px-4 cursor-pointer group focus:outline-none"
                                            data-carousel-next>
                                        <span class="inline-flex items-center justify-center w-8 h-8 rounded-full bg-sc-gray-light-active dark:bg-gray-800/30 group-hover:bg-white/50 dark:group-hover:bg-gray-800/60 group-focus:ring-4 group-focus:ring-white dark:group-focus:ring-gray-800/70 group-focus:outline-none">
                                            <svg xmlns="http://www.w3.org/2000/svg"
                                                    width="24"
                                                    height="24"
                                                    viewBox="0 0 24 24"
                                                    fill="none">
                                                <path d="M9.5 5L15.7929 11.2929C16.1834 11.6834 16.1834 12.3166 15.7929 12.7071L9.5 19" stroke="black" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                            </svg>
                                            <span class="sr-only">Next</span> </span>
                                    </button>
                            {% endif %}
                        </div>                          
                    </div>
                </div>
            {% endif %}
        </section>
        
                {% if not current_user.is_tailor %}
                    
                    <div class="px-4 pb-4 ">
                        {{ productsContainer("Related products", product.tailor.products, form=crsf)}}
                    </div>

                {% endif %}

                {% set select_measurement %}
                    <div class="py-3 space-y-5 text-sm text-sc-gray-darker leading-5">
                        <div class="flex items-center gap-3 font-normal">
                            <input id="default-radio-1"
                                   type="radio"
                                   value=""
                                   name="default-radio"
                                   x-bind:checked="useSavedMeasurement"
                                   x-on:change="useSavedMeasurement = !useSavedMeasurement, useNewMeasurement=false"
                                   class="w-4 h-4 ml-1 text-blue-600  border-pc-teal-normal border-1 focus:ring-blue-500 dark:focus:ring-blue-600 dark:ring-offset-gray-800 focus:ring-2 dark:bg-gray-700 dark:border-gray-600" />
                            <label for="default-radio-1"
                                   class="leading-5 ms-2 text-sm dark:text-gray-300">
                                Use my saved measurements
                            </label>
                        </div>

                        <div class="flex items-center gap-2"
                             data-drawer-target="bottom-sheet-measurement"
                             data-drawer-show="bottom-sheet-measurement"
                             data-drawer-placement="bottom"
                             aria-controls="bottom-sheet-measurement">
                            <svg xmlns="http://www.w3.org/2000/svg"
                                 width="24"
                                 height="24"
                                 viewBox="0 0 24 24"
                                 :class="{'stroke-white fill-pc-teal-normal': useNewMeasurement, 'stroke-pc-teal-normal': !useNewMeasurement}"
                                 fill="white">
                                <path d="M15 12H12M12 12H9M12 12V9M12 12V15M17 21H7C4.79086 21 3 19.2091 3 17V7C3 4.79086 4.79086 3 7 3H17C19.2091 3 21 4.79086 21 7V17C21 19.2091 19.2091 21 17 21Z" :stroke="#currentColor" stroke-width="1.5" stroke-linecap="round" />
                            </svg>
                            <label for="default-radio-2"
                                   class="leading-5 ms-2 text-sm  dark:text-gray-300">
                                Add new measurements
                            </label>
                        </div>
                    </div>

                    <!-- Warning sign -->
                    <div class="inline-flex items-center space-x-1 justify-center w-full">
                        <svg xmlns="http://www.w3.org/2000/svg"
                             width="19"
                             height="18"
                             viewBox="0 0 19 18"
                             fill="none">
                            <path d="M9.5 13.5C9.91421 13.5 10.25 13.1642 10.25 12.75C10.25 12.3358 9.91421 12 9.5 12C9.08579 12 8.75 12.3358 8.75 12.75C8.75 13.1642 9.08579 13.5 9.5 13.5Z" fill="#606060" />
                            <path d="M9.5 7.5V10.5" stroke="#606060" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                            <path d="M3.08608 13.5791L8.15899 3.43318C8.71181 2.32761 10.2895 2.32761 10.8423 3.43318L15.9153 13.5791C16.4139 14.5764 15.6887 15.7499 14.5736 15.7499H4.42772C3.31264 15.7499 2.5874 14.5764 3.08608 13.5791Z" stroke="#606060" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        <span class="text-xs text-sc-gray-dark leading-4 tracking-wider">Select a measurement to continue</span>
                    </div>

                    <!--  Button-->
                    <button type="button"
                            :disabled="!useSavedMeasurement"
                            :class="{ 'bg-sc-gray-light text-sc-gray cursor-not-allowed': !useSavedMeasurement && !useNewMeasurement, 'bg-pc-teal-normal text-white cursor-pointer': useSavedMeasurement || useNewMeasurement }"
                            class="text-sc-gray  text-sm  w-full hover:bg-gradient-to-br focus:ring-1 focus:outline-none focus:ring-teal-300 dark:focus:ring-teal-800 font-medium rounded-lg px-5 py-2.5 text-center me-2 mb-2">
                        Add measurement to order
                    </button>
                {% endset %}

                {% set add_measurement %}
                    {% set input_styles = "font-roboto leading-6 block px-3 pb-2.5 pt-4 w-full text-sm text-sc-gray-dark bg-transparent rounded-md border-1 border-[#888] appearance-none dark:text-white dark:border-gray-600 dark:focus:border-blue-500 focus:outline-none focus:ring-0 focus:border-blue-600 peer" %}
                    {% set label_styles = "absolute text-sm text-sc-gray-darker dark:text-gray-400 duration-300 transform -translate-y-4 scale-75 top-2 z-10 origin-[0] bg-white dark:bg-gray-900 px-2 peer-focus:px-2 peer-focus:text-blue-600 peer-focus:dark:text-blue-500 peer-placeholder-shown:scale-100 peer-placeholder-shown:-translate-y-1/2 peer-placeholder-shown:top-1/2 peer-focus:top-2 peer-focus:scale-75 peer-focus:-translate-y-4 start-1 rtl:peer-focus:translate-x-1/4 rtl:peer-focus:left-auto" %}

                    {% if current_user.is_authenticated and not current_user.is_tailor%}
                        <form novalidate
                              method="post"
                              action="{{ product.id }}/cart"
                              class="w-full flex flex-col gap-4 items-center">

                            {{ form.hidden_tag() }}

                            <div class="grid grid-cols-2 gap-4">
                                {% for field in form %}
                                    {% if field.type != 'CSRFTokenField' and field.type != 'SubmitField' %}
                                        <p class="relative">
                                            <!-- input -->
                                            {{ field(class=input_styles, placeholder="",
                                                                                        type="number",value=current_user.measurements[field.name]) }}
                                            <!-- label  -->
                                            {{ field.label(label='Ok', class=label_styles, for="default_outlined") }}

                                        </p>
                                    {% endif %}
                                {% endfor %}

                                <!-- <input type="hidden" name="product_id" value="{{product.id}}" /> -->

                            </div>
                            <!-- Warning sign -->
                            <div class="inline-flex items-center space-x-1 justify-center w-full">
                                <svg xmlns="http://www.w3.org/2000/svg"
                                     width="19"
                                     height="18"
                                     viewBox="0 0 19 18"
                                     fill="none">
                                    <path d="M9.5 13.5C9.91421 13.5 10.25 13.1642 10.25 12.75C10.25 12.3358 9.91421 12 9.5 12C9.08579 12 8.75 12.3358 8.75 12.75C8.75 13.1642 9.08579 13.5 9.5 13.5Z" fill="#606060" />
                                    <path d="M9.5 7.5V10.5" stroke="#606060" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                    <path d="M3.08608 13.5791L8.15899 3.43318C8.71181 2.32761 10.2895 2.32761 10.8423 3.43318L15.9153 13.5791C16.4139 14.5764 15.6887 15.7499 14.5736 15.7499H4.42772C3.31264 15.7499 2.5874 14.5764 3.08608 13.5791Z" stroke="#606060" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                                </svg>
                                <span class="text-xs text-sc-gray-dark leading-4 tracking-wider">All measurement are in cm</span>
                            </div>

                            <!--  Button-->
                            {{ form.submit(class="inline-block  text-white  text-sm  w-full bg-gradient-to-r from-pc-teal-normal to-pc-teal-normal  hover:bg-gradient-to-br focus:ring-1 focus:outline-none focus:ring-teal-300 dark:focus:ring-teal-800 font-medium rounded-lg px-5 py-2.5 text-center") }}
                        </form>
                    {% endif %}
                {% endset %}



                {{ bottomSheet(title="Measurement",
                                content=add_measurement,
                                sheetName="bottom-sheet-measurement") 
                }}

            </div>
            


            {% set sheet_content %}
            <div id="sheet-content" class="space-y-3 py-3">
              <h4 class="text-center font-roboto text-sm text-sc-gray-darker"
                  x-text="product_name">
              </h4>
      
      
                <form action="" class="grid grid-cols-2 gap-3">
                  {{ form.hidden_tag() }}
                  <!-- Hidden input field with the product ID -->
                  <input type="hidden" name="id" :value='product_id' />
                  <!--  Button-->
                  <button type="button"
                          hx-post='/move_to_draft'
                          hx-include="[name=id]"
                          hx-trigger="click"
                          class="text-pc-teal-normal  border-1 border-pc-teal-normal text-sm  w-full bg-white  hover:bg-gradient-to-br focus:ring-1 focus:outline-none focus:ring-teal-300 dark:focus:ring-teal-800 font-medium rounded-lg px-5 py-2.5 text-center me-2 mb-2">
                    Move to draft
                  </button>
                  <button type="button"
                          class="text-white  text-sm  w-full bg-gradient-to-r from-pc-teal-normal to-pc-teal-normal  hover:bg-gradient-to-br focus:ring-1 focus:outline-none focus:ring-teal-300 dark:focus:ring-teal-800 font-medium rounded-lg px-5 py-2.5 text-center me-2 mb-2"
                          hx-delete='/delete_product'
                          hx-include="[name=value]"
                          hx-trigger="click"
                          hx-target="#sheet-content"
                          hx-swap="innerHTML">
                    Yes delete
                  </button>
                </form>
      
            </div>
          {% endset %}
          <div id="modal"></div>]
     

<script>
                     const msgg = `{{message_list}}`;
    for (a of msgg){

        console.log(msgg);
    }
//    function  for  formatting time
function customTimeFormat(datetimeString, timezoneOffset = 1) {
                    // If the input is 'N/A', return 'N/A'
                    if (datetimeString === 'N/A') {
                        return 'N/A';
                    }
                    
                    // Create a new Date object from the datetime string
                    const date = new Date(datetimeString);
                
                    // Adjust for the specified timezone offset (in hours)
                    const localDate = new Date(date.getTime() + timezoneOffset * 3600000);
                    const now = new Date();
                    const diff = now - localDate;
                    
                    // Calculate the difference in various units
                    const seconds = Math.floor(diff / 1000);
                    const minutes = Math.floor(diff / 60000);
                    const hours = Math.floor(diff / 3600000) ;
                    const days = Math.floor(diff / 86400000);
                
                    // If the datetime is under 30 seconds
                    if (seconds < 30) {
                            return 'just now';
                    }

                    // If the datetime is under 60 seconds
                    if (seconds < 60) {
                            return `${seconds} seconds ago`;
                    }

                    // If the datetime is under 60 minutes
                    if (minutes < 60) {
                            return `${minutes} ${minutes === 1 ? 'miute': 'minutes'} ago`;
                    }

                
                    // If the datetime is exactly one day old
                    if (days === 1) {
                            const localHours = localDate.getUTCHours().toString().padStart(2, '0');
                            const localMinutes = localDate.getUTCMinutes().toString().padStart(2, '0');
                            return `Yesterday at ${localHours}:${localMinutes}`;
                    }

                    // For dates older than 24 hours
                    if (days > 1) {
                            // Get the day of the month and determine the correct suffix
                            const day = localDate.getUTCDate();
                            let suffix = 'th';
                            if (day % 10 === 1 && day !== 11) {
                                suffix = 'st';
                            } else if (day % 10 === 2 && day !== 12) {
                                suffix = 'nd';
                            } else if (day % 10 === 3 && day !== 13) {
                                suffix = 'rd';
                            }

                            // Get month, day, and year
                            const month = localDate.toLocaleString('default', { month: 'short' });
                            const year = localDate.getUTCFullYear();

                            // Format the datetime to the desired output
                            return `${month}, ${day}${suffix} ${year}`;
                    }
}

function formatCurrency(value) {
                return new Intl.NumberFormat('en-NG', {
                    style: 'currency',
                    currency: 'NGN'
                }).format(value);
}

// event listener for showing the chat modal on product page
document.getElementById('enquireId').onclick = async function() {
        
        let tailor_id;
        const pathname = window.location.pathname;
        const segments = pathname.split('/');
        const parameter = segments[2];

        console.log("this is parameter", parameter)


       

        try {
                            const response = await fetch(`/messages/${parameter}/chatseller`, {
                                method: 'GET',
                                headers: {
                                    'Accept': 'application/json'
                                }
                            });

                            if (!response.ok) {
                                throw new Error('Network response was not ok');
                            }
                            
                        
                            const div = document.getElementById('modal');
                            const messagesInterface = document.createElement('div');
                            messagesInterface.className = "flex flex-col pt-16 ml-1 mb-[80px]";
                            messagesInterface.id = "messages"
                            const content = await response.json();
                            const heading = `<div class="leading-[21px] font-normal font-roboto tracking-[0.5px] text-gray-800 text-[16px]" style="color: var(--Grey-Dark, #000);"> ${content.other_user.business_name}</div>`;
                            const imageInput= `<svg id="attach-button" xmlns="http://www.w3.org/2000/svg" width="14" height="15" viewBox="0 0 14 15" fill="none" style=" cursor: pointer;">
                                    <path d="M1 7.5H7M7 7.5H13M7 7.5V13.5M7 7.5V1.5" stroke="#2D2D2D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                            <input type="file" id="file-input" style="display: none;" accept="image/*" multiple="false">`;
                            const textInput =  ` <div > <input id="message-input" type="text" id="msg" class="rounded-lg placeholder-black   focus:outline-none focus:ring-0 focus:border-[white]  peer w-full" placeholder="Type here...." autocomplete="off"> </div>`;
                            
                            const sendBtn =  `<div id="send" class="">   <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 25" fill="none">
                                            <path d="M11.5003 12.5H5.41872M5.24634 13.2972L4.24158 16.2986C3.69128 17.9424 3.41613 18.7643 3.61359 19.2704C3.78506 19.71 4.15335 20.0432 4.6078 20.1701C5.13111 20.3161 5.92151 19.9604 7.50231 19.2491L17.6367 14.6886C19.1797 13.9942 19.9512 13.6471 20.1896 13.1648C20.3968 12.7458 20.3968 12.2541 20.1896 11.8351C19.9512 11.3529 19.1797 11.0057 17.6367 10.3114L7.48483 5.74303C5.90879 5.03382 5.12078 4.67921 4.59799 4.82468C4.14397 4.95101 3.77572 5.28336 3.60365 5.72209C3.40551 6.22728 3.67772 7.04741 4.22215 8.68767L5.24829 11.7793C5.34179 12.061 5.38855 12.2019 5.407 12.3459C5.42338 12.4738 5.42321 12.6032 5.40651 12.731C5.38768 12.875 5.34057 13.0157 5.24634 13.2972Z" stroke="#2D2D2D" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                                </svg>
                            </div>`;
                            const messageInputs = ` {{ messageBottom("${textInput}", "${sendBtn}","buttom") }}`;
                        

        if (content.messages) {
                // if the user has had conversattion with the tailor before display their chat history 
                for (const msg of content.messages) {
                    
                            //get the tailor_id for realtime emiting
                            if (msg.sender_user_id)
                                        tailor_id = msg.reciever_tailor_id;

                         
                            loadChatHistory(msg, messagesInterface);

                }
            
        }
       
        // Get the outerHTML of messagesInterface to pass to the macro
        const msgI = messagesInterface.outerHTML;
      
        
        // modalMessageTop is  a jinja macro that style the modal content
        div.innerHTML = `{{ modalMessageTop('${heading}', '${msgI}', "${messageInputs}") }}`;
        const mainModal = document.getElementById("overlay-for-modal");
        mainModal.tabIndex = -1;
        mainModal.focus();

        // function for scrolling the message down to the latest message
        function sleep(ms) {
                            return new Promise(resolve => setTimeout(resolve, ms));
        }
        async function scrollDownMessage() {
                    await sleep(0);
                    mainModal.scrollBy(0, mainModal.scrollHeight);
                        // Sleep for 2000 milliseconds (2 seconds)
          
        }
        
        //This case should have been handle in the modal macro definition but  for unknown reason I cannot add script to the macro definition 
        const cancelBtn = document.getElementById('cancel-modal');
        cancelBtn.addEventListener('click', cancelModal);
      
        // scroll down the mesage interface to last message after inserting content to it
        scrollDownMessage();
        // render any new message recieved in realtime
        rendernewlyRecievedMessage();

        //check for click event on send button and emit message to server in realtime
        document.getElementById('send').onclick = async function() {
                    console.log("Send button clicked event fired");
                    const messageText = document.getElementById('message-input');
                    if (!messageText.value) {
                                alert('Message cannot be empty');
                                return;
                    }

                    try {
                                const socket = io.connect();
                                const csrfToken = await getCSRFToken();
                                const product =   await sendPostRequest(messageText.value, csrfToken);
                                console.log(product);
                                const productMsg =   `<a href=" /products/${product.id}">     
                                                <div class= "flex flex-row gap-2  w-full  mb-2 p-[5px] rounded-[6px]" style="background-color:var(--White, #FFF);">
                                                <div class="">
                                                        <img src="${product.image }" class="h-[63px] rounded-md w-[63px]" alt="...">
                                                </div>
                                                <div class=" flex flex-col justify-between">
                                                    <p class="leading-[21px] font-normal font-roboto tracking-[0.4px] text-gray-800  text-[12px]" style="color: var(--Grey-Dark, #606060);" >${product.name}</p>
                                                    <p class="leading-[21px] font-normal font-roboto tracking-[0.4px] text-gray-800  text-[12px]" style="color:var(--Grey-Dark, #606060);" > ${formatCurrency(product.price)}</p>
                                                    <p class="leading-[21px] font-normal font-roboto tracking-[0.25px] text-gray-800  text-[14px]" style="color:var(--Grey-Darker, #2D2D2D);" >Order ID: #232102</p>

                                                </div> 


                                                </div>
                                            </a>`;
                                // Select the messages container in the DOM
                                const messagesContainer = document.getElementById('messages');
                                
                                const messageHTML = `{{ messages('right', '${messageText.value}', '${getCurrentTime24()}', '${productMsg}') }}`;
                                messagesContainer.scrollBottom = messagesContainer.scrollHeight;
                                messagesContainer.innerHTML += messageHTML;
                                scrollDownMessage();                    

                                socket.emit('send_message', {
                                            reciever_id: tailor_id,
                                            message: messageText ? messageText.value : null,
                                            image_url: null,
                                            product: product,
                                            the_image: null
                                        });
                                messageText.value = '';  // Clear input after successful request
                             
                    } catch (error) {
                        console.error('Error:', error);
                    }
                   
        };
             
      

        } catch (error) {
                console.error('There was a problem with the fetch operation:', error);
        }
};


//function to cancel the modal
function cancelModal(){

    const modal = document.getElementById('modal');
    modal.innerHTML = '';

}

// Function to handle sending a message when the send button is clicked and also render the message immidiately on the screen


       
 // connect to socketio for realtime imiting of message between sender and reciever
 function rendernewlyRecievedMessage(){
        const socket = io.connect();

        // Event listener for receiving  sender message from the server
        socket.on('recieve_message', (data) => {
                    console.log("Message received event fired",  data);
                    if (data.message == null){
                        data.message = ' ';    
                    }
                    // Select the messages container in the DOM
                    const messagesContainer = document.getElementById('messages');
                    const msg_img = `<a href="${data.image_url}" target="_blank">     
                                    <div class= "  mb-1 p-[2px] rounded-[6px]">
                                        <img src="${data.image_url}" class="h-[255px] w-full" alt="...">

                                </div>
                                </a>`;
                    
                    if (data.image_url) 
                    {
                        const messageHTML = `{{ messages('left', '${data.message}', '${getCurrentTime24()}', '${msg_img}') }}`;
                        messagesContainer.scrollBottom = messagesContainer.scrollHeight;
                        messagesContainer.innerHTML += messageHTML;   
                    }  
                    else {
                        const messageHTML = `{{ messages('left', '${data.message}', '${getCurrentTime24()}') }}`;
                        messagesContainer.scrollBottom = messagesContainer.scrollHeight;
                        messagesContainer.innerHTML += messageHTML;
                    }               
        
        });
}
    


function loadChatHistory(msg, messagesInterface) {
                 
                            
                                if (msg.media_url) {
                                            // render the message content  that contains image
                                            const image = `<a href="${msg.m_image}" target="_blank">     
                                                <div class="mb-1 p-[2px] rounded-[6px]">
                                                    <img src="${msg.m_image}" class="h-[255px] w-full" alt="...">
                                                </div>
                                            </a>`
                                            
                                            if (msg.sender_user_id ) 
                                            //render messages sent by this curren user to the right of user screen
                                            renderMessage('right', msg, image, messagesInterface);
                                            else    
                                            //render messages sent by the tailor to the user to the right
                                                renderMessage('left', msg, image, messagesInterface);
                                        
                                }
                                else if (msg.m_product){
                                    // render the message is sent from product page
                                        
                                            const productMsg =   `<a href=" /products/${msg.m_product.id}">     
                                                <div class= "flex flex-row gap-2  w-full  mb-2 p-[5px] rounded-[6px]" style="background-color:var(--White, #FFF);">
                                                <div class="">
                                                        <img src="${msg.m_product.img }" class="h-[63px] rounded-md w-[63px]" alt="...">
                                                </div>
                                                <div class=" flex flex-col justify-between">
                                                    <p class="leading-[21px] font-normal font-roboto tracking-[0.4px] text-gray-800  text-[12px]" style="color: var(--Grey-Dark, #606060);" >${msg.m_product.name}</p>
                                                    <p class="leading-[21px] font-normal font-roboto tracking-[0.4px] text-gray-800  text-[12px]" style="color:var(--Grey-Dark, #606060);" > ${formatCurrency(msg.m_product.price)}</p>
                                                    <p class="leading-[21px] font-normal font-roboto tracking-[0.25px] text-gray-800  text-[14px]" style="color:var(--Grey-Darker, #2D2D2D);" >Order ID: #232102</p>

                                                </div> 


                                                </div>
                                            </a>`;
                                            if (msg.sender_user_id ) 
                                            renderMessage('right', msg, productMsg, messagesInterface);
                                            else    
                                                renderMessage('left', msg, productMsg, messagesInterface);       
                    
                                }
                                else  {  
                                    //render text is sent through the main chat app not through modal 
                                            if (msg.sender_user_id ) 
                                                renderMessage('right', msg, null, messagesInterface);
                                            else    
                                                renderMessage('left', msg, null, messagesInterface);            
                    
                                }
                            
}  



 //fucntion to get current time
 function getCurrentTime24() {
                            const now = new Date();
                            const hours = now.getHours().toString().padStart(2, '0');
                            const minutes = now.getMinutes().toString().padStart(2, '0');
                            return `${hours}:${minutes}`;

                
 }   
            
            


 // Function to get CSRF token
 async function getCSRFToken() {
                        const response = await fetch('/get_csrf_token', {
                            method: 'GET',
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        });

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const data = await response.json();
                        return data.csrf_token;
 }
     
    
// Function to send the message as  POST request to indicate the message is from product page
 async function sendPostRequest(message, csrfToken) {
                        const url = `message/${parameter}`;
                        const messageData = { text: message };

                        const response = await fetch(url, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRFToken': csrfToken
                            },
                            body: JSON.stringify(messageData)
                        });

                        if (!response.ok) {
                            throw new Error('Network response was not ok');
                        }

                        const data = await response.json();
                        console.log('Success:', data);
                        return data;
}

 //function to render the sender and reciever message on the message interface screen
function renderMessage(side, msg, img, mInterface){

                            let messageHTML;

                            if (side =="left")
                            {
                                            if (img && msg.message){
                                                messageHTML = `{{ messages('left', '${msg.message}', '${customTimeFormat(msg.created_at)}', '${img}') }}`;
                                            }
                                            else if (img && !msg.message){

                                                messageHTML = `{{ messages('left', ' ', '${customTimeFormat(msg.created_at)}', '${img}') }}`;
                                            }
                                            else {
                                                messageHTML = `{{ messages('left', '${msg.message} ', '${customTimeFormat(msg.created_at)}') }}`;
                                            }



                            }
                            else{
                                            if (img && msg.message){
                                                messageHTML = `{{ messages('right', '${msg.message}', '${customTimeFormat(msg.created_at)}', '${img}') }}`;
                                            }
                                            else if (img && !msg.message){

                                                messageHTML = `{{ messages('right', ' ', '${customTimeFormat(msg.created_at)}', '${img}') }}`;
                                            }
                                            else {
                                            messageHTML = `{{ messages('right', '${msg.message} ', '${customTimeFormat(msg.created_at)}') }}`;
                                            }


                            }

                            // Create a temporary container to hold the new message HTML
                            const tempDiv = document.createElement('div');
                            tempDiv.innerHTML = messageHTML;

                            // Prepend the new message to the messagesInterface
                            while (tempDiv.firstChild) {
                                    mInterface.appendChild(tempDiv.firstChild);
                            }

}

</script>
{% endblock %}