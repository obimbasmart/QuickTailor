{% extends 'base.html' %}
{% from 'macros/notification.html' import notify %}
{% from 'macros/tailorBadge.html' import tailorBadge   %}

{% block content %}
    <div id="notification-container" class="flex flex-col  mt-16 mx-[16px]  gap-2 font-roboto bg-white">
      <!-- Notifications will be dynamically inserted here -->
    </div>

  <script>
    function formatDateTimeTo24hrs(datetimeString) {
            return moment(datetimeString).format('HH:mm');
        }
    function getCurrentTime24() {
            const now = new Date();
            const hours = now.getHours().toString().padStart(2, '0');
            const minutes = now.getMinutes().toString().padStart(2, '0');
            return `${hours}:${minutes}`;
        }

    const socket = io.connect();

    // Event listener for successful connection
    socket.on('connect', () => {
    console.log('Connected to the server');
    });



    socket.on('new_notification', (notification) => {
            const container = document.getElementById('notification-container');
            const div = document.createElement('div');
	    console.log(notification)
            div.className = 'notification';
            div.setAttribute('data-id', notification.id);
            div.setAttribute('data-url', notification.url);
            div.innerHTML = `{{ notify('0', '${notification.content}', '${getCurrentTime24()}', tailorBadge()) }}`;
            div.addEventListener('click', () => {
                                fetch(`/notifications/${notification.id}`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Network response was not ok');
                                        }
                                        // Redirect to the notification URL
                                        window.location.href = notification.url;
                                        div.firstElementChild.style.background = "white";

                                    })
                                    .catch(error => {
                                        console.error('There was a problem with the fetch operation:', error);
                                    });
                            });


            container.prepend(div);


    });


    document.addEventListener('DOMContentLoaded', (event) => {
        let page = 1;
        const container = document.getElementById('notification-container');
        container.innerText = '';

        // Function to load notifications from the server
        const loadNotifications = () => {
            fetch(`/get_notifications?page=${page}`)
                .then(response => response.json())
                .then(data => {
                    if (data.length > 0) {
                        data.forEach(notification => {
                            const div = document.createElement('div');
                            div.className = 'notification';
                            div.setAttribute('data-id', notification.id);
                            div.setAttribute('data-url', notification.url);

                            // Render the notification using the Jinja2 macro
					  if (notification.is_clicked)
				          {
					          div.innerHTML = `{{ notify('1', '${notification.content}', '${formatDateTimeTo24hrs(notification.created_at)}', tailorBadge()) }}`;
					  }
					  else 
					  div.innerHTML = `{{ notify('0', '${notification.content}', '${formatDateTimeTo24hrs(notification.created_at)}', tailorBadge()) }}`;


                            // Add the click event listener to the notification
                            div.addEventListener('click', () => {
                                fetch(`/notifications/${notification.id}`)
                                    .then(response => {
                                        if (!response.ok) {
                                            throw new Error('Network response was not ok');
                                        }
                                        // Redirect to the notification URL
                                        window.location.href = notification.url;
				        div.firstElementChild.style.background = "white";

                                    })
                                    .catch(error => {
                                        console.error('There was a problem with the fetch operation:', error);
                                    });
                            });

                            // Append the notification to the container
                            container.prepend(div);
                        });
                        page++;
                    }
		   else if (container.innerText == ''){

                           container.innerHTML= `<p class="text-center text-[14px]" style="color: var(--Grey-Dark, #606060);"> You have no notification yet </p>`
			 }
                })
                .catch(error => {
                    console.error('Error loading notifications:', error);
                });
        };

        // Handle the scroll event for infinite scrolling
        const handleScroll = () => {
            if (window.innerHeight + window.scrollY >= document.body.offsetHeight) {
                loadNotifications();
            }
        };

        window.addEventListener('scroll', handleScroll);
        loadNotifications(); // Initial load
    });

  </script>
{% endblock %}

